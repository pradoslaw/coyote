{% extends 'adm.base' %}
{% block title %}Użytkownicy :: {{ user.name }} :: {{ parent() }}{% endblock %}

{% block container %}
  {{ activity.chartLibrarySourceHtml }}

  <div class="card card-default">
    <div class="card-header">
      <div class="d-flex justify-content-between">
        <span>Użytkownik: {{ activity.mention }}</span>
        <span>
          <i class="fas fa-eye fa-fw"></i>
          Podgląd aktywności
        </span>
      </div>
    </div>

    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between">
        <span><b>Utworzenie konta</b>: {{ activity.accountCreatedAt }}</span>
        <div>
          <b>{{ activity.createdAgoMajor }}</b>
          <span class="text-muted">{{ activity.createdAgoMinor }}</span>
        </div>
      </li>
    </ul>
  </div>

  <div class="card card-default">
    <div class="card-header">
      Okres
    </div>

    <div class="card-body">
      <div class="btn-group">
        <a href="?" class="btn btn-secondary">
          <i class="far fa-calendar-check"></i>
          Wszystko
        </a>
        <a href="?last=year" type="button" class="btn btn-secondary">
          <i class="far fa-calendar fa-fw"></i>
          Ostatnie 365 dni
        </a>
        <a href="?last=month" type="button" class="btn btn-secondary">
          <i class="fas fa-calendar-alt fa-fw"></i>
          Ostatnie 31 dni
        </a>
        <a href="?last=week" type="button" class="btn btn-secondary">
          <i class="fas fa-calendar-week fa-fw"></i>
          Ostatnie 7 dni
        </a>
        <a href="?last=day" type="button" class="btn btn-secondary">
          <i class="fas fa-calendar-day fa-fw"></i>
          Ostatnie 24h
        </a>
      </div>
    </div>
  </div>

  {% if activity.hasAnyPosts %}
    <div class="d-flex">
      <div class="card card-default w-50 align-self-start">
        <div class="card-header">
          Posty i wątki {{ activity.mention }}
        </div>
        <ul class="list-group table-list-group list-group-flush">
          {% for post in activity.posts %}
            <li class="list-group-item post-list-item {{ post.deleted ? 'deleted' : '' }}" style="overflow:visible;">
              <div class="d-flex justify-content-between">
                <p class="mb-0">
                  {% if post.isThread %}
                    <i class="far fa-comments"></i>
                    <span class="ml-1 badge badge-secondary">Wątek</span>
                  {% else %}
                    <i class="far fa-comment"></i>
                    <span class="ml-1 badge badge-secondary">Post</span>
                  {% endif %}
                  {% if post.deleted %}
                    <span class="ml-1 badge badge-secondary">Usunięty</span>
                  {% endif %}
                  <small class="text-muted ml-1">
                    {{ post.dateString }}
                  </small>
                </p>
                <p class="mb-0 text-right">
                  <a href="{{ post.forumUrl }}" class="text-nowrap">
                    {{ post.forumName }}
                  </a>
                </p>
              </div>
              <a href="{{ post.postUrl }}">
                <b>{{ post.topicTitle }}</b>
              </a>
              {% if not post.isLong %}
                <div>
                  <div class="d-inline-block post-content-excerpt mt-1 rounded p-2 post-preview">
                    {{ post.html }}
                  </div>
                </div>
              {% else %}
                <div class="d-flex mt-1">
                  <div class="flex-grow-1 post-content-excerpt rounded p-2 post-preview">
                    {{ post.previewHtml }}
                  </div>
                  <button class="btn btn-secondary text-nowrap ml-2 btn-show-preview align-self-start">
                    <i class="fas fa-eye"></i>
                    Pokaż całość
                  </button>
                </div>
                <div class="position-relative">
                  <div class="full-preview position-absolute d-none" style="top:4px; z-index:10;">
                    <div class="rounded p-2 post-preview">
                      {{ post.html }}
                    </div>
                  </div>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>

      <div class="w-50 pl-3">
        <div class="card card-default">
          <div class="card-header">
            Powody usunięcia
          </div>
          <div class="card-body">
            {% if activity.hasDeleteReasons %}
              {{ activity.deleteReasonsChart }}
            {% else %}
              Użytkownik <b>nie ma</b> usuniętych postów.
            {% endif %}
          </div>
        </div>
        <div class="card card-default">
          <div class="card-header">
            Kategorie
          </div>
          <div class="card-body">
            {{ activity.categoriesChart }}
          </div>
        </div>

        <div class="card card-default">
          <div class="card-header">
            Napisane posty
          </div>
          <div class="card-body">
            {{ activity.postsChart }}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if not activity.hasAnyPosts %}
    <div class="card card-default">
      <div class="card-header">
        Posty użytkownika
      </div>
      <div class="card-body">
        Użytkownik darmozjad nie dodał <b>żadnych</b> postów w podanym zakresie.
      </div>
    </div>
  {% endif %}

  <style>
      small {
          font-size: 0.75em;
      }

      img.img-smile {
          height: 1em;
      }

      .post-content-excerpt p {
          margin: 0;
      }

      .deleted {
          opacity: 0.5;
      }

      .deleted:hover {
          opacity: 0.9;
      }

      body.theme-dark .post-preview {
          background-color: #111111;
          border-color: #333333;
      }

      .post-preview {
          background-color: #eee;
          border: 1px solid #ccc;
      }
  </style>

  <script>
    (function () {
      const list = document.querySelector('.table-list-group');

      Array.from(document.querySelectorAll('.btn-show-preview'))
        .forEach(button => {
          button.addEventListener('click', function (event) {
            const button = event.target;

            const listItem = button.closest('li.post-list-item');
            const wasVisible = previewVisible(listItem);

            Array.from(list.querySelectorAll('li.post-list-item'))
              .forEach(listItem => togglePreview(listItem, false))

            togglePreview(listItem, !wasVisible);
          });
        })

      function togglePreview(listItem, visible) {
        const preview = listItem.querySelector('.full-preview');
        if (preview) {
          preview.classList.toggle('d-none', !visible);
        }
      }

      function previewVisible(listItem) {
        const preview = listItem.querySelector('.full-preview');
        return !preview.classList.contains('d-none');
      }
    })();
  </script>
{% endblock %}
